<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Projet Practise</title>
    <style></style>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>My WhatsApp</h1>
    <div class="roomenter">
      <label for="room">join this room</label>
      <p id="roomnumber"></p>
      <input type="text" id="roomvalue" placeholder="enter room id" />
      <button id="entertheroom">Enter</button>
    </div>
    <h2>Please type this text</h2>
    <div id="para-place"></div>
    <input type="text" id="input-field" />

    <div id="text-shower-field"></div>
    <div id="car_container"></div>
    <script
      src="https://cdn.socket.io/4.6.0/socket.io.min.js"
      integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
      crossorigin="anonymous"
    ></script>

    <script>
      const socket = io("http://localhost:8080", {
        transports: ["websocket"],
      });

      //=============================================================================================================>
      let roomnumber = document.querySelector("#roomnumber");
      let joinbutton = document.querySelector("#entertheroom");
      let room = document.querySelector(".roomenter");
      joinbutton.addEventListener("click", Join);

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get("nickname");
      let roomvalue = urlParams.get("roomvalue");
      let value = urlParams.get("value");

      console.log(username);

      if (value == 0) {
        room.style.display = "block";
        socket.emit("username", { username });
        socket.on("roomno", (id) => {
          roomnumber.innerText = id;
        });
      } else if (value == 1) {
        socket.emit("joinroom", { username, roomvalue });
      }
      function Join() {
        let roomvalue = document.querySelector("#roomvalue").value;
        socket.emit("joinroom", { username, roomvalue });
      }
      socket.on("message", (message) => {
        console.log(message);
      });

      //============================================================================================>
      //recieving paragraph from server
      let myGlobalPara;
      socket.on("thePara", (para) => {
        console.log(para);
        myGlobalPara = para;
        document.getElementById("para-place").innerText = para;
      });

      //getting the input value here and sending to server for validation
      let index = -1;
      document
        .getElementById("input-field")
        .addEventListener("keyup", (event) => {
          const typedText = event.target.value;
          let keyCode = event.keyCode;
          index++;
          if (typedText.length <= myGlobalPara.length) {
            socket.emit("typedText", { typedText, keyCode });
          }
        });

      // Receive validation result from the server
      socket.on("reverse", (data) => {
        console.log(data);
      });

      //when user joins
      socket.on("car-joined", ({ socketID }) => {
        console.log(socketID);
        if (socketID) {
          const carElement = document.createElement("div");
          // carElement.id = `${socketID}`;
          carElement.className = "car";
          let img = document.createElement("img");
          img.setAttribute("id", `${socketID}`);
          img.setAttribute(
            "src",
            "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ-mFTBi_muR16A0lX1mtrvoJMpiZPC7Fbkf6SWv3KATDeJs1750MyakJKyocm22onnj7w&usqp=CAU"
          );
          carElement.append(img);
          document.getElementById("car_container").append(carElement);
        }
      });

      //updating the word per minute and moving the car from here
      const wordsPerMinute = 60;
      const carSpeed = 200; // adjust this as needed

      socket.on(
        "typing-update",
        ({ socketID, isTyping, typedText, flag, wordCount, totalWords }) => {
          console.log(typedText, flag);
          const car_img = document.getElementById(`${socketID}`);
          if (isTyping) {
            const speed = (+wordCount / wordsPerMinute) * carSpeed;
            // car_img.style.animationDuration = `${speed}ms`;
          } else {
            // car_img.style.animationDuration = "0s";
          }
        }
      );

      //getting the user data here
      socket.on("user_data", (data) => {
        console.log(data);
      });
    </script>
  </body>
</html>
